@import 'tailwindcss';
@import 'shepherd.js/dist/css/shepherd.css' layer(vendor);

/*
 * CSS Cascade Layer Order
 *
 * Layers are evaluated in declaration order - later layers win over earlier ones.
 * Tailwind v4 uses: theme, base, components, utilities.
 * We add: vendor (before, for third-party CSS) and overrides (after, for customizations).
 */
@layer vendor, theme, base, components, utilities, overrides;

/*
 * Body: indigo-50 to match Home page. Authenticated pages cover with bg-white.
 * Unlayered to override @layer base.
 */
body {
  background-color: #eef2ff; /* indigo-50 */
}

@theme {
  --animate-radar-sweep: radar-sweep 0.6s linear forwards;
  --animate-radar-wedge: radar-wedge 0.6s linear forwards;

  /*
   * Z-Index Scale
   *
   * Semantic layers with 100-unit gaps for future insertion.
   * All z-index values should use these tokens (e.g., z-dropdown, z-modal).
   * Local stacking (z-1, z-2) within a component's own context is fine.
   *
   * - dropdown (100): Dropdowns, popovers, menus
   * - sticky (200): Sticky headers within content
   * - fixed (300): Fixed navigation (header, sidebar)
   * - modal-backdrop (400): Dark overlay behind modals
   * - modal (500): Modal dialogs, bottom sheets
   * - confirm (550): Confirmation dialogs layered above modals
   * - toast (600): Toast notifications, banners
   * - tooltip (700): Tooltips, hover cards
   * - tour (800): React tour fallback overlay (Shepherd uses its own 9997/9999)
   * - tour-modal (10000): Modals during tour - must be above Shepherd tooltip (9999)
   */
  --z-index-dropdown: 100;
  --z-index-sticky: 200;
  --z-index-fixed: 300;
  --z-index-modal-backdrop: 400;
  --z-index-modal: 500;
  --z-index-confirm: 550;
  --z-index-toast: 600;
  --z-index-tooltip: 700;
  --z-index-tour: 800;
  --z-index-tour-modal: 10000;
}

/* Radar sweep animation - smooth reveal using conic-gradient mask */
@property --sweep-angle {
  syntax: '<angle>';
  initial-value: 0deg;
  inherits: false;
}

@keyframes radar-sweep {
  /* Wait for wedge to grow (0-25%) */
  0% {
    --sweep-angle: 0deg;
  }
  25% {
    --sweep-angle: 0deg;
  }
  /* Track wedge trailing edge exactly */
  75% {
    --sweep-angle: 270deg;
  }
  100% {
    --sweep-angle: 360deg;
  }
}

.animate-radar-sweep {
  mask-image: conic-gradient(
    from 0deg at 50% 50%,
    black var(--sweep-angle),
    transparent var(--sweep-angle)
  );
  -webkit-mask-image: conic-gradient(
    from 0deg at 50% 50%,
    black var(--sweep-angle),
    transparent var(--sweep-angle)
  );
}

/* Radar wedge - grows from 0° to 90°, rotates, then shrinks */
@property --wedge-start {
  syntax: '<angle>';
  initial-value: 0deg;
  inherits: false;
}

@property --wedge-end {
  syntax: '<angle>';
  initial-value: 0deg;
  inherits: false;
}

@keyframes radar-wedge {
  /* Start: no wedge */
  0% {
    --wedge-start: 0deg;
    --wedge-end: 0deg;
  }
  /* Growth phase: wedge expands to 90° */
  25% {
    --wedge-start: 0deg;
    --wedge-end: 90deg;
  }
  /* Rotation phase complete: wedge at end position */
  75% {
    --wedge-start: 270deg;
    --wedge-end: 360deg;
  }
  /* Shrink: trailing edge catches up */
  100% {
    --wedge-start: 360deg;
    --wedge-end: 360deg;
  }
}

@layer base {
  body {
    /* Background color is set unlayered above — see comment there */
    @apply text-gray-900 antialiased;
  }
}

@layer utilities {
  /* Screen reader only - visually hidden but accessible */
  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border-width: 0;
  }
}

/*
 * Shepherd.js tour customizations
 *
 * These styles override Shepherd's defaults to match our app's design system.
 * They're in the 'overrides' layer, which has higher priority than the 'vendor'
 * layer where shepherd.css is imported - no !important needed.
 */
@layer overrides {
  .shepherd-element {
    /* Must be above overlay for buttons to be clickable.
       Shepherd default: 9999 (tooltip) vs 9997 (overlay). */
    z-index: 9999;
    border-radius: 0.375rem; /* rounded-md */
    box-shadow:
      0 10px 15px -3px rgb(0 0 0 / 0.1),
      0 4px 6px -4px rgb(0 0 0 / 0.1); /* shadow-lg */
  }

  .shepherd-content {
    border-radius: 0.375rem;
  }

  .shepherd-text {
    padding: 1rem;
    font-size: 0.875rem; /* text-sm */
    line-height: 1.5rem;
    color: #374151; /* text-gray-700 */
  }

  .shepherd-header {
    padding: 0.75rem 1rem 0;
  }

  .shepherd-cancel-icon {
    color: #9ca3af; /* text-gray-400 */
    font-size: 1.5rem;
    font-weight: 400;
  }

  .shepherd-cancel-icon:hover {
    color: #6b7280; /* text-gray-500 */
  }

  .shepherd-footer {
    padding: 0.75rem 1rem 1rem;
    gap: 0.5rem;
  }

  /* Base button styles for all tour buttons */
  .shepherd-button {
    border-radius: 0.375rem;
    padding: 0.5rem 1rem;
    font-size: 0.875rem;
    font-weight: 500;
    transition:
      background-color 150ms,
      box-shadow 150ms;
  }

  /* Primary button (Next, Finish) */
  .shepherd-button:not(.shepherd-button-secondary):not(.shepherd-button-skip) {
    background-color: #4f46e5; /* bg-indigo-600 */
    color: white;
    border: none;
    box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
  }

  .shepherd-button:not(.shepherd-button-secondary):not(.shepherd-button-skip):hover {
    background-color: #4338ca; /* bg-indigo-700 */
  }

  .shepherd-button:not(.shepherd-button-secondary):not(.shepherd-button-skip):focus {
    /* outline: none removed - let .tour-keyboard-focus control outline */
    box-shadow:
      0 0 0 2px white,
      0 0 0 4px #6366f1; /* ring-2 ring-indigo-500 ring-offset-2 */
  }

  /* Secondary button (Back) - white with border, fixed to left side */
  .shepherd-button-secondary {
    background-color: white;
    color: #374151; /* text-gray-700 */
    border: 1px solid #d1d5db; /* border-gray-300 */
    box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
    margin-right: auto; /* Keep Back button on left even when Next is hidden */
  }

  .shepherd-button-secondary:hover {
    background-color: #f9fafb; /* bg-gray-50 */
  }

  .shepherd-button-secondary:focus {
    /* outline: none removed - let .tour-keyboard-focus control outline */
    box-shadow:
      0 0 0 2px white,
      0 0 0 4px #6366f1;
  }

  /* Hide the arrow pointing to target element */
  .shepherd-arrow {
    display: none;
  }

  /* Disable Shepherd's overlay fade transitions.
     Our body::before overlay fills in during page transitions - we need instant
     switches between overlays to avoid double-darkness flash. */
  .shepherd-modal-overlay-container {
    z-index: 9997; /* Must be below tooltip (9999) for buttons to be clickable */
    transition: none;
  }

  /* Lighten Shepherd's overlay (default is 0.5) */
  .shepherd-modal-overlay-container.shepherd-modal-is-visible {
    opacity: 0.2;
  }

  /* Override Shepherd's pointer-events: all on the overlay path.
     Without this, the SVG path intercepts clicks even with correct z-index.
     Uses !important because CSS layer cascading isn't winning reliably. */
  .shepherd-modal-overlay-container.shepherd-modal-is-visible path {
    pointer-events: none !important;
  }

  /* Visual focus ring for tour keyboard navigation.
     Native <dialog> elements trap focus, so we can't reliably use :focus.
     This class is added via JS to indicate which element Enter will activate.
     Uses outline instead of box-shadow to avoid clipping issues with dialog elements.
     Must override .shepherd-button:focus which sets outline:none (specificity 0,4,0). */
  .shepherd-button.tour-keyboard-focus,
  .shepherd-button.tour-keyboard-focus:focus,
  a.tour-keyboard-focus,
  a.tour-keyboard-focus:focus {
    outline: 5px solid red !important; /* DEBUG: bright red to test if outlines render */
    outline-offset: 4px !important;
  }
}

/*
 * Tour overlay system - instant switch between our overlay and Shepherd's.
 *
 * Our React-rendered overlay fills in during page transitions when Shepherd's
 * overlay is absent. When Shepherd's overlay becomes visible, we instantly hide
 * ours via :has() to avoid double-darkness. Shepherd's fade transitions are
 * disabled above to make the switch truly instant.
 */
body:has(.shepherd-modal-overlay-container.shepherd-modal-is-visible) .tour-fallback-overlay {
  opacity: 0;
}
